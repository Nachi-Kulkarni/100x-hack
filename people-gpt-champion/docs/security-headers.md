# HTTP Security Headers

To enhance the security of the People GPT Champion application, several HTTP security headers are configured globally via `next.config.ts`. These headers help protect against common web vulnerabilities.

## 1. Implemented Security Headers

The following security headers are applied to all responses from the application:

-   **`Content-Security-Policy` (CSP)**: Controls the resources the browser is allowed to load for the application.
-   **`Strict-Transport-Security` (HSTS)**: Enforces the use of HTTPS.
-   **`X-Content-Type-Options`**: Prevents browsers from MIME-sniffing a response away from the declared content-type.
-   **`X-Frame-Options`**: Provides clickjacking protection.
-   **`Referrer-Policy`**: Controls how much referrer information is sent with requests.
-   **`Permissions-Policy`**: Manages permissions for browser features and APIs.

## 2. Content-Security-Policy (CSP) Details

The CSP is a powerful header that helps prevent Cross-Site Scripting (XSS), clickjacking, and other code injection attacks.

**Current CSP String (as generated by `next.config.ts`):**

```
default-src 'self'; script-src 'self' 'unsafe-eval' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https: lh3.googleusercontent.com *.googleusercontent.com avatars.githubusercontent.com; font-src 'self' https: data:; object-src 'none'; base-uri 'self'; form-action 'self'; frame-ancestors 'none'; upgrade-insecure-requests
```

**Directive Breakdown:**

-   **`default-src 'self';`**
    -   **Purpose:** Acts as a fallback for other CSP fetch directives if they are not explicitly defined.
    -   **Current Value:** `'self'` restricts loading of resources (scripts, styles, images, fonts, etc.) to the application's own origin by default.

-   **`script-src 'self' 'unsafe-eval' 'unsafe-inline';`**
    -   **Purpose:** Defines valid sources for JavaScript.
    -   **Current Value:**
        -   `'self'`: Allows scripts from the application's own origin.
        -   `'unsafe-eval'`: Allows the use of `eval()` and similar methods. **Warning:** This is generally considered insecure and is often required for development builds of frameworks like Next.js (due to HMR or how JS bundles are created). For production, this should be removed if possible, or mitigated by ensuring no user-supplied input ever reaches `eval()`.
        -   `'unsafe-inline'`: Allows inline `<script>` elements and inline event handlers (e.g., `onclick=""`). **Warning:** This is also insecure. For production, it's best to avoid inline scripts. If unavoidable, use hashes or nonces for specific inline scripts, though this requires more complex server-side nonce generation and management (e.g., using the `X-CSP-Nonce` header example mentioned in `next.config.ts` if a nonce strategy is implemented).

-   **`style-src 'self' 'unsafe-inline';`**
    -   **Purpose:** Defines valid sources for stylesheets (CSS).
    -   **Current Value:**
        -   `'self'`: Allows stylesheets from the application's own origin.
        -   `'unsafe-inline'`: Allows inline `<style>` elements and `style=""` attributes. **Warning:** Less secure than external stylesheets. For production, aim to use external stylesheets. If inline styles are dynamically generated from user input (which should be avoided), this is a risk. If they are static or controlled by the application, the risk is lower but still present.

-   **`img-src 'self' data: https: lh3.googleusercontent.com *.googleusercontent.com avatars.githubusercontent.com;`**
    -   **Purpose:** Defines valid sources for images.
    -   **Current Value:**
        -   `'self'`: Allows images from the application's own origin.
        -   `data:`: Allows images embedded as data URIs.
        -   `https:`: Allows images from any HTTPS source. **Note:** This is quite permissive. For better security, replace `https:` with specific, trusted HTTPS origins if all image sources are known.
        -   `lh3.googleusercontent.com *.googleusercontent.com`: Allows images from Google's user content domains (used for Google Sign-In profile pictures).
        -   `avatars.githubusercontent.com`: Allows images from GitHub's avatar service.

-   **`font-src 'self' https: data:;`**
    -   **Purpose:** Defines valid sources for fonts.
    -   **Current Value:** Allows fonts from the application's own origin, any HTTPS source, and data URIs. Similar to `img-src`, `https:` can be narrowed down to specific origins in production.

-   **`object-src 'none';`**
    -   **Purpose:** Restricts sources for plugins (e.g., `<object>`, `<embed>`, `<applet>`).
    -   **Current Value:** `'none'` disallows all plugin sources, which is generally recommended for security as plugins can be an attack vector.

-   **`base-uri 'self';`**
    -   **Purpose:** Restricts the URLs that can be used in a document's `<base>` element.
    -   **Current Value:** `'self'` allows only the application's own origin.

-   **`form-action 'self';`**
    -   **Purpose:** Restricts the URLs to which forms can submit data.
    -   **Current Value:** `'self'` allows forms to submit only to the application's own origin.

-   **`frame-ancestors 'none';`**
    -   **Purpose:** Controls whether the site can be embedded in an `<iframe>`, `<frame>`, `<object>`, `<embed>`, or `<applet>` on other pages. This is a primary defense against clickjacking.
    -   **Current Value:** `'none'` prevents the site from being framed by any page, including itself. If specific framing is required (e.g., for certain internal tools), list those origins instead.

-   **`upgrade-insecure-requests;`**
    -   **Purpose:** Instructs browsers to treat all of a site's insecure URLs (those served over HTTP) as though they have been replaced with secure URLs (those served over HTTPS).
    -   **Current Value:** The directive is present (no specific value needed).

### CSP Testing Strategy (Manual)

Testing the Content Security Policy is primarily a manual process, best conducted in a staging or development environment that mirrors production as closely as possible, with the CSP enabled.

1.  **Browser Developer Tools:**
    *   Open your browser's developer console (usually by pressing F12).
    *   Navigate to the "Console" tab. CSP violations are reported here, typically indicating which directive was violated, the blocked resource, and the source of the resource.

2.  **Navigate Key Pages and Features:**
    *   Thoroughly navigate all parts of the application. Pay special attention to pages and features that involve:
        *   **Forms:** Test form submissions.
        *   **Images and Media:** Ensure all legitimate images, videos, etc., load correctly.
        *   **Third-Party Integrations:** Check any integrations, such as OAuth login flows (though these often occur in pop-ups or new windows that might have their own CSP or operate outside the main page's CSP).
        *   **Dynamic Content Loading:** Verify any content loaded via AJAX or WebSockets.
        *   **UI Elements:** Test any UI components that rely on specific JavaScript behaviors, inline styles, or dynamically loaded assets.

3.  **Iterative Refinement:**
    *   If legitimate resources are blocked by the CSP (breaking site functionality), the relevant CSP directive (e.g., `script-src`, `img-src`, `style-src`, `connect-src` for API calls) needs to be updated to allow that source.
    *   This is an iterative process:
        1.  Observe a violation.
        2.  Identify the blocked resource and the violated directive.
        3.  If the resource is legitimate, update the directive in `next.config.ts` to include its source (e.g., add a domain to `img-src`).
        4.  Re-test.
    *   The goal is to make the policy as restrictive as possible without breaking essential application functionality.

4.  **CSP Reporting (Optional Advanced Feature):**
    *   For production environments, consider implementing CSP reporting. This involves adding a `report-uri` (older, widely supported) or `report-to` (newer, more structured) directive to your CSP.
    *   `report-uri /api/csp-reports;` (Example: You would need to create this API endpoint to receive and log reports).
    *   This sends JSON reports of CSP violations to a specified endpoint, allowing for monitoring of potential issues, misconfigurations, or attempted XSS attacks in real-time.
    *   *Note: Implementing the reporting endpoint itself is out of scope for this documentation task.*

## 3. Other Security Headers

The following headers are also configured:

-   **`Strict-Transport-Security: max-age=63072000; includeSubDomains; preload`**
    -   **Purpose:** Enforces secure (HTTPS) connections to the server.
    -   **`max-age=63072000`**: Tells browsers to only connect via HTTPS for two years.
    -   **`includeSubDomains`**: Applies the rule to all subdomains.
    -   **`preload`**: Allows the site to be submitted to browser HSTS preload lists.

-   **`X-Content-Type-Options: nosniff`**
    -   **Purpose:** Prevents the browser from interpreting files as a different MIME type than what is specified by the `Content-Type` header. This mitigates attacks related to MIME-sniffing.

-   **`X-Frame-Options: SAMEORIGIN`**
    -   **Purpose:** Provides clickjacking protection by controlling if and how the site can be embedded in a `<frame>`, `<iframe>`, `<embed>`, or `<object>`.
    -   **`SAMEORIGIN`**: Allows the page to be framed only by pages from the same origin.
    -   *Note: The `frame-ancestors` directive in CSP is more modern and generally preferred, but `X-Frame-Options` is included for broader browser compatibility.*

-   **`Referrer-Policy: strict-origin-when-cross-origin`**
    -   **Purpose:** Controls how much referrer information (the page the user came from) is included with requests.
    -   **`strict-origin-when-cross-origin`**: Sends the full URL when making same-origin requests, but only sends the origin (scheme, host, port) for cross-origin requests. This is a good balance between utility and privacy.

-   **`Permissions-Policy: camera=(), microphone=(), geolocation=(), payment=()`**
    -   **Purpose:** Allows or blocks the use of browser features and APIs on the site.
    -   **Current Value:** Disables `camera`, `microphone`, `geolocation`, and `payment` APIs by default for all contexts (top-level and iframes). This is a security best practice to disable features not explicitly needed. If a feature (e.g., camera for profile picture upload) is required, it should be explicitly allowed for `'self'` or specific origins. Example: `camera=(self)`.

These headers collectively contribute to a more secure application environment. Regular review and updates are recommended as security best practices evolve.
